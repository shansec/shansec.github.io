<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>字符串的扩展 | 未来可期的博客</title>
    <meta property="og:title" content="字符串的扩展 - 未来可期的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2024-04-24T09:58:44&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2024-04-24T09:58:44&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,未来可期,博客,公众号,小程序">
    <meta name="description" content="字符串的扩展">
        
    <meta name="author" content="未来可期">
    <meta property="og:url" content="http://shansec.github.io/post/es6/%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%89%A9%E5%B1%95/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://shansec.github.io">
                        未来可期的博客
                    </a>
                
                <p class="description">专注于Go语言(golang)、前端技术</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://shansec.github.io">Home</a>
                    
                    <a  href="http://shansec.github.io/archives/" title="归档">归档</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">Table of Contents</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#字符的-unicode-表示法">字符的 Unicode 表示法</a></li>
    <li><a href="#字符串的遍历器接口">字符串的遍历器接口</a></li>
    <li><a href="#直接输入-u2028-和-u2029">直接输入 U+2028 和 U+2029</a></li>
    <li><a href="#jsonstringify-的改造">JSON.stringify() 的改造</a></li>
    <li><a href="#模板字符串">模板字符串</a></li>
    <li><a href="#实例模板编译">实例：模板编译</a></li>
    <li><a href="#标签模板">标签模板</a></li>
    <li><a href="#模板字符串的限制">模板字符串的限制</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if (leftPos < 220) {
                postToc.css({ "width": leftPos - 10, "margin-left": (0 - leftPos) })
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }

        if ($("#TableOfContents").children().length < 1) {
            $(".post-toc").remove();
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">字符串的扩展</h1>
        </header>
        
  <time datetime="2024-04-24T01:58:44Z" class="post-meta meta-date dt-published">
    2024-04-24
  </time>


<div class="post-meta meta-category">
  <span>&nbsp;|</span>
  
    <a href='/categories/%E5%89%8D%E7%AB%AF' target="_blank">前端</a>
  
</div>


        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">&nbsp;|
                <span id="busuanzi_value_page_pv"></span> <span>reads</span>
            </span>
        </div>
        
        
        <div class="post-content">
            <p>本章介绍 ES6 对字符串的改造和增强，下一章介绍字符串对象的新增方法。</p>
<h2 id="字符的-unicode-表示法">字符的 Unicode 表示法</h2>
<p>ES6 加强了对 Unicode 的支持，允许采用<code>\uxxxx</code>形式表示一个字符，其中<code>xxxx</code>表示字符的 Unicode 码点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#d14">&#34;\u0061&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;a&#34;
</span></span></span></code></pre></div><p>但是，这种表示法只限于码点在<code>\u0000</code>~<code>\uFFFF</code>之间的字符。超出这个范围的字符，必须用两个双字节的形式表示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#d14">&#34;\uD842\uDFB7&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;𠮷&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#34;\u20BB7&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34; 7&#34;
</span></span></span></code></pre></div><p>上面代码表示，如果直接在<code>\u</code>后面跟上超过<code>0xFFFF</code>的数值（比如<code>\u20BB7</code>），JavaScript 会理解成<code>\u20BB+7</code>。由于<code>\u20BB</code>是一个不可打印字符，所以只会显示一个空格，后面跟着一个<code>7</code>。</p>
<p>ES6 对这一点做出了改进，只要将码点放入大括号，就能正确解读该字符。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#d14">&#34;\u{20BB7}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;𠮷&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#34;\u{41}\u{42}\u{43}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;ABC&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> hello <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">123</span>;
</span></span><span style="display:flex;"><span>hell<span style="color:#a61717;background-color:#e3d2d2">\</span>u{<span style="color:#099">6</span>F} <span style="color:#998;font-style:italic">// 123
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#39;\u{1F680}&#39;</span> <span style="color:#000;font-weight:bold">===</span> <span style="color:#d14">&#39;\uD83D\uDE80&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// true
</span></span></span></code></pre></div><p>上面代码中，最后一个例子表明，大括号表示法与四字节的 UTF-16 编码是等价的。</p>
<p>有了这种表示法之后，JavaScript 共有 6 种方法可以表示一个字符。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#d14">&#39;\z&#39;</span> <span style="color:#000;font-weight:bold">===</span> <span style="color:#d14">&#39;z&#39;</span>  <span style="color:#998;font-style:italic">// true
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#d14">&#39;\172&#39;</span> <span style="color:#000;font-weight:bold">===</span> <span style="color:#d14">&#39;z&#39;</span> <span style="color:#998;font-style:italic">// true
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#d14">&#39;\x7A&#39;</span> <span style="color:#000;font-weight:bold">===</span> <span style="color:#d14">&#39;z&#39;</span> <span style="color:#998;font-style:italic">// true
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#d14">&#39;\u007A&#39;</span> <span style="color:#000;font-weight:bold">===</span> <span style="color:#d14">&#39;z&#39;</span> <span style="color:#998;font-style:italic">// true
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#d14">&#39;\u{7A}&#39;</span> <span style="color:#000;font-weight:bold">===</span> <span style="color:#d14">&#39;z&#39;</span> <span style="color:#998;font-style:italic">// true
</span></span></span></code></pre></div><h2 id="字符串的遍历器接口">字符串的遍历器接口</h2>
<p>ES6 为字符串添加了遍历器接口（详见《Iterator》一章），使得字符串可以被<code>for...of</code>循环遍历。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> (<span style="color:#000;font-weight:bold">let</span> codePoint <span style="color:#000;font-weight:bold">of</span> <span style="color:#d14">&#39;foo&#39;</span>) {
</span></span><span style="display:flex;"><span>  console.log(codePoint)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;f&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;o&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;o&#34;
</span></span></span></code></pre></div><p>除了遍历字符串，这个遍历器最大的优点是可以识别大于<code>0xFFFF</code>的码点，传统的<code>for</code>循环无法识别这样的码点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> text <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">String</span>.fromCodePoint(<span style="color:#099">0x20BB7</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> (<span style="color:#000;font-weight:bold">let</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> text.length; i<span style="color:#000;font-weight:bold">++</span>) {
</span></span><span style="display:flex;"><span>  console.log(text[i]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34; &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34; &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> (<span style="color:#000;font-weight:bold">let</span> i <span style="color:#000;font-weight:bold">of</span> text) {
</span></span><span style="display:flex;"><span>  console.log(i);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;𠮷&#34;
</span></span></span></code></pre></div><p>上面代码中，字符串<code>text</code>只有一个字符，但是<code>for</code>循环会认为它包含两个字符（都不可打印），而<code>for...of</code>循环会正确识别出这一个字符。</p>
<h2 id="直接输入-u2028-和-u2029">直接输入 U+2028 和 U+2029</h2>
<p>JavaScript 字符串允许直接输入字符，以及输入字符的转义形式。举例来说，“中”的 Unicode 码点是 U+4e2d，你可以直接在字符串里面输入这个汉字，也可以输入它的转义形式<code>\u4e2d</code>，两者是等价的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#d14">&#39;中&#39;</span> <span style="color:#000;font-weight:bold">===</span> <span style="color:#d14">&#39;\u4e2d&#39;</span> <span style="color:#998;font-style:italic">// true
</span></span></span></code></pre></div><p>但是，JavaScript 规定有5个字符，不能在字符串里面直接使用，只能使用转义形式。</p>
<ul>
<li>U+005C：反斜杠（reverse solidus)</li>
<li>U+000D：回车（carriage return）</li>
<li>U+2028：行分隔符（line separator）</li>
<li>U+2029：段分隔符（paragraph separator）</li>
<li>U+000A：换行符（line feed）</li>
</ul>
<p>举例来说，字符串里面不能直接包含反斜杠，一定要转义写成<code>\\</code>或者<code>\u005c</code>。</p>
<p>这个规定本身没有问题，麻烦在于 JSON 格式允许字符串里面直接使用 U+2028（行分隔符）和 U+2029（段分隔符）。这样一来，服务器输出的 JSON 被<code>JSON.parse</code>解析，就有可能直接报错。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> json <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;&#34;\u2028&#34;&#39;</span>;
</span></span><span style="display:flex;"><span>JSON.parse(json); <span style="color:#998;font-style:italic">// 可能报错
</span></span></span></code></pre></div><p>JSON 格式已经冻结（RFC 7159），没法修改了。为了消除这个报错，<a href="https://github.com/tc39/proposal-json-superset">ES2019</a> 允许 JavaScript 字符串直接输入 U+2028（行分隔符）和 U+2029（段分隔符）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> PS <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">eval</span>(<span style="color:#d14">&#34;&#39;\u2029&#39;&#34;</span>);
</span></span></code></pre></div><p>根据这个提案，上面的代码不会报错。</p>
<p>注意，模板字符串现在就允许直接输入这两个字符。另外，正则表达式依然不允许直接输入这两个字符，这是没有问题的，因为 JSON 本来就不允许直接包含正则表达式。</p>
<h2 id="jsonstringify-的改造">JSON.stringify() 的改造</h2>
<p>根据标准，JSON 数据必须是 UTF-8 编码。但是，现在的<code>JSON.stringify()</code>方法有可能返回不符合 UTF-8 标准的字符串。</p>
<p>具体来说，UTF-8 标准规定，<code>0xD800</code>到<code>0xDFFF</code>之间的码点，不能单独使用，必须配对使用。比如，<code>\uD834\uDF06</code>是两个码点，但是必须放在一起配对使用，代表字符<code>𝌆</code>。这是为了表示码点大于<code>0xFFFF</code>的字符的一种变通方法。单独使用<code>\uD834</code>和<code>\uDF06</code>这两个码点是不合法的，或者颠倒顺序也不行，因为<code>\uDF06\uD834</code>并没有对应的字符。</p>
<p><code>JSON.stringify()</code>的问题在于，它可能返回<code>0xD800</code>到<code>0xDFFF</code>之间的单个码点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>JSON.stringify(<span style="color:#d14">&#39;\u{D834}&#39;</span>) <span style="color:#998;font-style:italic">// &#34;\u{D834}&#34;
</span></span></span></code></pre></div><p>为了确保返回的是合法的 UTF-8 字符，<a href="https://github.com/tc39/proposal-well-formed-stringify">ES2019</a> 改变了<code>JSON.stringify()</code>的行为。如果遇到<code>0xD800</code>到<code>0xDFFF</code>之间的单个码点，或者不存在的配对形式，它会返回转义字符串，留给应用自己决定下一步的处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>JSON.stringify(<span style="color:#d14">&#39;\u{D834}&#39;</span>) <span style="color:#998;font-style:italic">// &#34;&#34;\\uD834&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>JSON.stringify(<span style="color:#d14">&#39;\uDF06\uD834&#39;</span>) <span style="color:#998;font-style:italic">// &#34;&#34;\\udf06\\ud834&#34;&#34;
</span></span></span></code></pre></div><h2 id="模板字符串">模板字符串</h2>
<p>传统的 JavaScript 语言，输出模板通常是这样写的（下面使用了 jQuery 的方法）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>$(<span style="color:#d14">&#39;#result&#39;</span>).append(
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#39;There are &lt;b&gt;&#39;</span> <span style="color:#000;font-weight:bold">+</span> basket.count <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#39;&lt;/b&gt; &#39;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#39;items in your basket, &#39;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#39;&lt;em&gt;&#39;</span> <span style="color:#000;font-weight:bold">+</span> basket.onSale <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#39;&lt;/em&gt; are on sale!&#39;</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>上面这种写法相当繁琐不方便，ES6 引入了模板字符串解决这个问题。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>$(<span style="color:#d14">&#39;#result&#39;</span>).append(<span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  There are &lt;b&gt;</span><span style="color:#d14">${</span>basket.count<span style="color:#d14">}</span><span style="color:#d14">&lt;/b&gt; items
</span></span></span><span style="display:flex;"><span><span style="color:#d14">   in your basket, &lt;em&gt;</span><span style="color:#d14">${</span>basket.onSale<span style="color:#d14">}</span><span style="color:#d14">&lt;/em&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  are on sale!
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`</span>);
</span></span></code></pre></div><p>模板字符串（template string）是增强版的字符串，用反引号（`）标识。它可以当作普通字符串使用，也可以用来定义多行字符串，或者在字符串中嵌入变量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 普通字符串
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#d14">`In JavaScript &#39;\n&#39; is a line-feed.`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 多行字符串
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#d14">`In JavaScript this is
</span></span></span><span style="display:flex;"><span><span style="color:#d14"> not legal.`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>console.log(<span style="color:#d14">`string text line 1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">string text line 2`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 字符串中嵌入变量
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">let</span> name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;Bob&#34;</span>, time <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;today&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#d14">`Hello </span><span style="color:#d14">${</span>name<span style="color:#d14">}</span><span style="color:#d14">, how are you </span><span style="color:#d14">${</span>time<span style="color:#d14">}</span><span style="color:#d14">?`</span>
</span></span></code></pre></div><p>上面代码中的模板字符串，都是用反引号表示。如果在模板字符串中需要使用反引号，则前面要用反斜杠转义。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> greeting <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">`\`Yo\` World!`</span>;
</span></span></code></pre></div><p>如果使用模板字符串表示多行字符串，所有的空格和缩进都会被保留在输出之中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>$(<span style="color:#d14">&#39;#list&#39;</span>).html(<span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&lt;ul&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;li&gt;first&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;li&gt;second&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&lt;/ul&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`</span>);
</span></span></code></pre></div><p>上面代码中，所有模板字符串的空格和换行，都是被保留的，比如<code>&lt;ul&gt;</code>标签前面会有一个换行。如果你不想要这个换行，可以使用<code>trim</code>方法消除它。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>$(<span style="color:#d14">&#39;#list&#39;</span>).html(<span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&lt;ul&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;li&gt;first&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;li&gt;second&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&lt;/ul&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`</span>.trim());
</span></span></code></pre></div><p>模板字符串中嵌入变量，需要将变量名写在<code>${}</code>之中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> authorize(user, action) {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>user.hasPrivilege(action)) {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> <span style="color:#0086b3">Error</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">// 传统写法为
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// &#39;User &#39;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// + user.name
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// + &#39; is not authorized to do &#39;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// + action
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// + &#39;.&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      <span style="color:#d14">`User </span><span style="color:#d14">${</span>user.name<span style="color:#d14">}</span><span style="color:#d14"> is not authorized to do </span><span style="color:#d14">${</span>action<span style="color:#d14">}</span><span style="color:#d14">.`</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>大括号内部可以放入任意的 JavaScript 表达式，可以进行运算，以及引用对象属性。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> x <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> y <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d14">`</span><span style="color:#d14">${</span>x<span style="color:#d14">}</span><span style="color:#d14"> + </span><span style="color:#d14">${</span>y<span style="color:#d14">}</span><span style="color:#d14"> = </span><span style="color:#d14">${</span>x <span style="color:#000;font-weight:bold">+</span> y<span style="color:#d14">}</span><span style="color:#d14">`</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;1 + 2 = 3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#d14">`</span><span style="color:#d14">${</span>x<span style="color:#d14">}</span><span style="color:#d14"> + </span><span style="color:#d14">${</span>y <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">2</span><span style="color:#d14">}</span><span style="color:#d14"> = </span><span style="color:#d14">${</span>x <span style="color:#000;font-weight:bold">+</span> y <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">2</span><span style="color:#d14">}</span><span style="color:#d14">`</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;1 + 4 = 5&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> obj <span style="color:#000;font-weight:bold">=</span> {x<span style="color:#000;font-weight:bold">:</span> <span style="color:#099">1</span>, y<span style="color:#000;font-weight:bold">:</span> <span style="color:#099">2</span>};
</span></span><span style="display:flex;"><span><span style="color:#d14">`</span><span style="color:#d14">${</span>obj.x <span style="color:#000;font-weight:bold">+</span> obj.y<span style="color:#d14">}</span><span style="color:#d14">`</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;3&#34;
</span></span></span></code></pre></div><p>模板字符串之中还能调用函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> fn() {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;Hello World&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d14">`foo </span><span style="color:#d14">${</span>fn()<span style="color:#d14">}</span><span style="color:#d14"> bar`</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// foo Hello World bar
</span></span></span></code></pre></div><p>如果大括号中的值不是字符串，将按照一般的规则转为字符串。比如，大括号中是一个对象，将默认调用对象的<code>toString</code>方法。</p>
<p>如果模板字符串中的变量没有声明，将报错。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 变量place没有声明
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">let</span> msg <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">`Hello, </span><span style="color:#d14">${</span>place<span style="color:#d14">}</span><span style="color:#d14">`</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 报错
</span></span></span></code></pre></div><p>由于模板字符串的大括号内部，就是执行 JavaScript 代码，因此如果大括号内部是一个字符串，将会原样输出。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#d14">`Hello </span><span style="color:#d14">${</span><span style="color:#d14">&#39;World&#39;</span><span style="color:#d14">}</span><span style="color:#d14">`</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;Hello World&#34;
</span></span></span></code></pre></div><p>模板字符串甚至还能嵌套。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> tmpl <span style="color:#000;font-weight:bold">=</span> addrs =&gt; <span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;table&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  </span><span style="color:#d14">${</span>addrs.map(addr =&gt; <span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &lt;tr&gt;&lt;td&gt;</span><span style="color:#d14">${</span>addr.first<span style="color:#d14">}</span><span style="color:#d14">&lt;/td&gt;&lt;/tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &lt;tr&gt;&lt;td&gt;</span><span style="color:#d14">${</span>addr.last<span style="color:#d14">}</span><span style="color:#d14">&lt;/td&gt;&lt;/tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  `</span>).join(<span style="color:#d14">&#39;&#39;</span>)<span style="color:#d14">}</span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;/table&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`</span>;
</span></span></code></pre></div><p>上面代码中，模板字符串的变量之中，又嵌入了另一个模板字符串，使用方法如下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> data <span style="color:#000;font-weight:bold">=</span> [
</span></span><span style="display:flex;"><span>    { first<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;&lt;Jane&gt;&#39;</span>, last<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;Bond&#39;</span> },
</span></span><span style="display:flex;"><span>    { first<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;Lars&#39;</span>, last<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;&lt;Croft&gt;&#39;</span> },
</span></span><span style="display:flex;"><span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>console.log(tmpl(data));
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &lt;table&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//   &lt;tr&gt;&lt;td&gt;&lt;Jane&gt;&lt;/td&gt;&lt;/tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//   &lt;tr&gt;&lt;td&gt;Bond&lt;/td&gt;&lt;/tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//   &lt;tr&gt;&lt;td&gt;Lars&lt;/td&gt;&lt;/tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//   &lt;tr&gt;&lt;td&gt;&lt;Croft&gt;&lt;/td&gt;&lt;/tr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &lt;/table&gt;
</span></span></span></code></pre></div><p>如果需要引用模板字符串本身，在需要时执行，可以写成函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> func <span style="color:#000;font-weight:bold">=</span> (name) =&gt; <span style="color:#d14">`Hello </span><span style="color:#d14">${</span>name<span style="color:#d14">}</span><span style="color:#d14">!`</span>;
</span></span><span style="display:flex;"><span>func(<span style="color:#d14">&#39;Jack&#39;</span>) <span style="color:#998;font-style:italic">// &#34;Hello Jack!&#34;
</span></span></span></code></pre></div><p>上面代码中，模板字符串写成了一个函数的返回值。执行这个函数，就相当于执行这个模板字符串了。</p>
<h2 id="实例模板编译">实例：模板编译</h2>
<p>下面，我们来看一个通过模板字符串，生成正式模板的实例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> template <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&lt;ul&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;% for(let i=0; i &lt; data.supplies.length; i++) { %&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &lt;li&gt;&lt;%= data.supplies[i] %&gt;&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;% } %&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&lt;/ul&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`</span>;
</span></span></code></pre></div><p>上面代码在模板字符串之中，放置了一个常规模板。该模板使用<code>&lt;%...%&gt;</code>放置 JavaScript 代码，使用<code>&lt;%= ... %&gt;</code>输出 JavaScript 表达式。</p>
<p>怎么编译这个模板字符串呢？</p>
<p>一种思路是将其转换为 JavaScript 表达式字符串。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>echo(<span style="color:#d14">&#39;&lt;ul&gt;&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span>(<span style="color:#000;font-weight:bold">let</span> i<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> data.supplies.length; i<span style="color:#000;font-weight:bold">++</span>) {
</span></span><span style="display:flex;"><span>  echo(<span style="color:#d14">&#39;&lt;li&gt;&#39;</span>);
</span></span><span style="display:flex;"><span>  echo(data.supplies[i]);
</span></span><span style="display:flex;"><span>  echo(<span style="color:#d14">&#39;&lt;/li&gt;&#39;</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>echo(<span style="color:#d14">&#39;&lt;/ul&gt;&#39;</span>);
</span></span></code></pre></div><p>这个转换使用正则表达式就行了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> evalExpr <span style="color:#000;font-weight:bold">=</span> <span style="color:#009926">/&lt;%=(.+?)%&gt;/g</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> expr <span style="color:#000;font-weight:bold">=</span> <span style="color:#009926">/&lt;%([\s\S]+?)%&gt;/g</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>template <span style="color:#000;font-weight:bold">=</span> template
</span></span><span style="display:flex;"><span>  .replace(evalExpr, <span style="color:#d14">&#39;`); \n  echo( $1 ); \n  echo(`&#39;</span>)
</span></span><span style="display:flex;"><span>  .replace(expr, <span style="color:#d14">&#39;`); \n $1 \n  echo(`&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>template <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;echo(`&#39;</span> <span style="color:#000;font-weight:bold">+</span> template <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#39;`);&#39;</span>;
</span></span></code></pre></div><p>然后，将<code>template</code>封装在一个函数里面返回，就可以了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> script <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span><span style="color:#d14">`(function parse(data){
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  let output = &#34;&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  function echo(html){
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    output += html;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  </span><span style="color:#d14">${</span> template <span style="color:#d14">}</span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  return output;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">})`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">return</span> script;
</span></span></code></pre></div><p>将上面的内容拼装成一个模板编译函数<code>compile</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> compile(template){
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">const</span> evalExpr <span style="color:#000;font-weight:bold">=</span> <span style="color:#009926">/&lt;%=(.+?)%&gt;/g</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">const</span> expr <span style="color:#000;font-weight:bold">=</span> <span style="color:#009926">/&lt;%([\s\S]+?)%&gt;/g</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  template <span style="color:#000;font-weight:bold">=</span> template
</span></span><span style="display:flex;"><span>    .replace(evalExpr, <span style="color:#d14">&#39;`); \n  echo( $1 ); \n  echo(`&#39;</span>)
</span></span><span style="display:flex;"><span>    .replace(expr, <span style="color:#d14">&#39;`); \n $1 \n  echo(`&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  template <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;echo(`&#39;</span> <span style="color:#000;font-weight:bold">+</span> template <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#39;`);&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">let</span> script <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d14">`(function parse(data){
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    let output = &#34;&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    function echo(html){
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      output += html;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    </span><span style="color:#d14">${</span> template <span style="color:#d14">}</span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    return output;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  })`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> script;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>compile</code>函数的用法如下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> parse <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">eval</span>(compile(template));
</span></span><span style="display:flex;"><span>div.innerHTML <span style="color:#000;font-weight:bold">=</span> parse({ supplies<span style="color:#000;font-weight:bold">:</span> [ <span style="color:#d14">&#34;broom&#34;</span>, <span style="color:#d14">&#34;mop&#34;</span>, <span style="color:#d14">&#34;cleaner&#34;</span> ] });
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//   &lt;ul&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//     &lt;li&gt;broom&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//     &lt;li&gt;mop&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//     &lt;li&gt;cleaner&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//   &lt;/ul&gt;
</span></span></span></code></pre></div><h2 id="标签模板">标签模板</h2>
<p>模板字符串的功能，不仅仅是上面这些。它可以紧跟在一个函数名后面，该函数将被调用来处理这个模板字符串。这被称为“标签模板”功能（tagged template）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>alert<span style="color:#d14">`hello`</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 等同于
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>alert([<span style="color:#d14">&#39;hello&#39;</span>])
</span></span></code></pre></div><p>标签模板其实不是模板，而是函数调用的一种特殊形式。“标签”指的就是函数，紧跟在后面的模板字符串就是它的参数。</p>
<p>但是，如果模板字符里面有变量，就不是简单的调用了，而是会将模板字符串先处理成多个参数，再调用函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> a <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tag<span style="color:#d14">`Hello </span><span style="color:#d14">${</span> a <span style="color:#000;font-weight:bold">+</span> b <span style="color:#d14">}</span><span style="color:#d14"> world </span><span style="color:#d14">${</span> a <span style="color:#000;font-weight:bold">*</span> b <span style="color:#d14">}</span><span style="color:#d14">`</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 等同于
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>tag([<span style="color:#d14">&#39;Hello &#39;</span>, <span style="color:#d14">&#39; world &#39;</span>, <span style="color:#d14">&#39;&#39;</span>], <span style="color:#099">15</span>, <span style="color:#099">50</span>);
</span></span></code></pre></div><p>上面代码中，模板字符串前面有一个标识名<code>tag</code>，它是一个函数。整个表达式的返回值，就是<code>tag</code>函数处理模板字符串后的返回值。</p>
<p>函数<code>tag</code>依次会接收到多个参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> tag(stringArr, value1, value2){
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 等同于
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> tag(stringArr, ...values){
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span></code></pre></div><p><code>tag</code>函数的第一个参数是一个数组，该数组的成员是模板字符串中那些没有变量替换的部分，也就是说，变量替换只发生在数组的第一个成员与第二个成员之间、第二个成员与第三个成员之间，以此类推。</p>
<p><code>tag</code>函数的其他参数，都是模板字符串各个变量被替换后的值。由于本例中，模板字符串含有两个变量，因此<code>tag</code>会接受到<code>value1</code>和<code>value2</code>两个参数。</p>
<p><code>tag</code>函数所有参数的实际值如下。</p>
<ul>
<li>第一个参数：<code>['Hello ', ' world ', '']</code></li>
<li>第二个参数: 15</li>
<li>第三个参数：50</li>
</ul>
<p>也就是说，<code>tag</code>函数实际上以下面的形式调用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>tag([<span style="color:#d14">&#39;Hello &#39;</span>, <span style="color:#d14">&#39; world &#39;</span>, <span style="color:#d14">&#39;&#39;</span>], <span style="color:#099">15</span>, <span style="color:#099">50</span>)
</span></span></code></pre></div><p>我们可以按照需要编写<code>tag</code>函数的代码。下面是<code>tag</code>函数的一种写法，以及运行结果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> a <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> tag(s, v1, v2) {
</span></span><span style="display:flex;"><span>  console.log(s[<span style="color:#099">0</span>]);
</span></span><span style="display:flex;"><span>  console.log(s[<span style="color:#099">1</span>]);
</span></span><span style="display:flex;"><span>  console.log(s[<span style="color:#099">2</span>]);
</span></span><span style="display:flex;"><span>  console.log(v1);
</span></span><span style="display:flex;"><span>  console.log(v2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;OK&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tag<span style="color:#d14">`Hello </span><span style="color:#d14">${</span> a <span style="color:#000;font-weight:bold">+</span> b <span style="color:#d14">}</span><span style="color:#d14"> world </span><span style="color:#d14">${</span> a <span style="color:#000;font-weight:bold">*</span> b<span style="color:#d14">}</span><span style="color:#d14">`</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;Hello &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34; world &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 15
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 50
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;OK&#34;
</span></span></span></code></pre></div><p>下面是一个更复杂的例子。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> total <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">30</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> msg <span style="color:#000;font-weight:bold">=</span> passthru<span style="color:#d14">`The total is </span><span style="color:#d14">${</span>total<span style="color:#d14">}</span><span style="color:#d14"> (</span><span style="color:#d14">${</span>total<span style="color:#000;font-weight:bold">*</span><span style="color:#099">1.05</span><span style="color:#d14">}</span><span style="color:#d14"> with tax)`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> passthru(literals) {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">let</span> result <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">let</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">while</span> (i <span style="color:#000;font-weight:bold">&lt;</span> literals.length) {
</span></span><span style="display:flex;"><span>    result <span style="color:#000;font-weight:bold">+=</span> literals[i<span style="color:#000;font-weight:bold">++</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> (i <span style="color:#000;font-weight:bold">&lt;</span> arguments.length) {
</span></span><span style="display:flex;"><span>      result <span style="color:#000;font-weight:bold">+=</span> arguments[i];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>msg <span style="color:#998;font-style:italic">// &#34;The total is 30 (31.5 with tax)&#34;
</span></span></span></code></pre></div><p>上面这个例子展示了，如何将各个参数按照原来的位置拼合回去。</p>
<p><code>passthru</code>函数采用 rest 参数的写法如下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> passthru(literals, ...values) {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">let</span> output <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">let</span> index;
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">for</span> (index <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; index <span style="color:#000;font-weight:bold">&lt;</span> values.length; index<span style="color:#000;font-weight:bold">++</span>) {
</span></span><span style="display:flex;"><span>    output <span style="color:#000;font-weight:bold">+=</span> literals[index] <span style="color:#000;font-weight:bold">+</span> values[index];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  output <span style="color:#000;font-weight:bold">+=</span> literals[index]
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> output;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>“标签模板”的一个重要应用，就是过滤 HTML 字符串，防止用户输入恶意内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> message <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>  SaferHTML<span style="color:#d14">`&lt;p&gt;</span><span style="color:#d14">${</span>sender<span style="color:#d14">}</span><span style="color:#d14"> has sent you a message.&lt;/p&gt;`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> SaferHTML(templateData) {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">let</span> s <span style="color:#000;font-weight:bold">=</span> templateData[<span style="color:#099">0</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">for</span> (<span style="color:#000;font-weight:bold">let</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>; i <span style="color:#000;font-weight:bold">&lt;</span> arguments.length; i<span style="color:#000;font-weight:bold">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">let</span> arg <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">String</span>(arguments[i]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// Escape special characters in the substitution.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    s <span style="color:#000;font-weight:bold">+=</span> arg.replace(<span style="color:#009926">/&amp;/g</span>, <span style="color:#d14">&#34;&amp;amp;&#34;</span>)
</span></span><span style="display:flex;"><span>            .replace(<span style="color:#009926">/&lt;/g</span>, <span style="color:#d14">&#34;&amp;lt;&#34;</span>)
</span></span><span style="display:flex;"><span>            .replace(<span style="color:#009926">/&gt;/g</span>, <span style="color:#d14">&#34;&amp;gt;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// Don&#39;t escape special characters in the template.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    s <span style="color:#000;font-weight:bold">+=</span> templateData[i];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> s;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>上面代码中，<code>sender</code>变量往往是用户提供的，经过<code>SaferHTML</code>函数处理，里面的特殊字符都会被转义。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> sender <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;&lt;script&gt;alert(&#34;abc&#34;)&lt;/script&gt;&#39;</span>; <span style="color:#998;font-style:italic">// 恶意代码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">let</span> message <span style="color:#000;font-weight:bold">=</span> SaferHTML<span style="color:#d14">`&lt;p&gt;</span><span style="color:#d14">${</span>sender<span style="color:#d14">}</span><span style="color:#d14"> has sent you a message.&lt;/p&gt;`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>message
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &lt;p&gt;&amp;lt;script&amp;gt;alert(&#34;abc&#34;)&amp;lt;/script&amp;gt; has sent you a message.&lt;/p&gt;
</span></span></span></code></pre></div><p>标签模板的另一个应用，就是多语言转换（国际化处理）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>i18n<span style="color:#d14">`Welcome to </span><span style="color:#d14">${</span>siteName<span style="color:#d14">}</span><span style="color:#d14">, you are visitor number </span><span style="color:#d14">${</span>visitorNumber<span style="color:#d14">}</span><span style="color:#d14">!`</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// &#34;欢迎访问xxx，您是第xxxx位访问者！&#34;
</span></span></span></code></pre></div><p>模板字符串本身并不能取代 Mustache 之类的模板库，因为没有条件判断和循环处理功能，但是通过标签函数，你可以自己添加这些功能。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 下面的hashTemplate函数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 是一个自定义的模板处理函数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">let</span> libraryHtml <span style="color:#000;font-weight:bold">=</span> hashTemplate<span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;ul&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    #for book in </span><span style="color:#d14">${</span>myBooks<span style="color:#d14">}</span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      &lt;li&gt;&lt;i&gt;#{book.title}&lt;/i&gt; by #{book.author}&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    #end
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;/ul&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`</span>;
</span></span></code></pre></div><p>除此之外，你甚至可以使用标签模板，在 JavaScript 语言之中嵌入其他语言。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>jsx<span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &lt;div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &lt;input
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      ref=&#39;input&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      onChange=&#39;</span><span style="color:#d14">${</span><span style="color:#000;font-weight:bold">this</span>.handleChange<span style="color:#d14">}</span><span style="color:#d14">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      defaultValue=&#39;</span><span style="color:#d14">${</span><span style="color:#000;font-weight:bold">this</span>.state.value<span style="color:#d14">}</span><span style="color:#d14">&#39; /&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      </span><span style="color:#d14">${</span><span style="color:#000;font-weight:bold">this</span>.state.value<span style="color:#d14">}</span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">   &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`</span>
</span></span></code></pre></div><p>上面的代码通过<code>jsx</code>函数，将一个 DOM 字符串转为 React 对象。你可以在 GitHub 找到<code>jsx</code>函数的<a href="https://gist.github.com/lygaret/a68220defa69174bdec5">具体实现</a>。</p>
<p>下面则是一个假想的例子，通过<code>java</code>函数，在 JavaScript 代码之中运行 Java 代码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>java<span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">class HelloWorldApp {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  public static void main(String[] args) {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    System.out.println(&#34;Hello World!&#34;); // Display the string.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`</span>
</span></span><span style="display:flex;"><span>HelloWorldApp.main();
</span></span></code></pre></div><p>模板处理函数的第一个参数（模板字符串数组），还有一个<code>raw</code>属性。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>console.log<span style="color:#d14">`123`</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// [&#34;123&#34;, raw: Array[1]]
</span></span></span></code></pre></div><p>上面代码中，<code>console.log</code>接受的参数，实际上是一个数组。该数组有一个<code>raw</code>属性，保存的是转义后的原字符串。</p>
<p>请看下面的例子。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>tag<span style="color:#d14">`First line\nSecond line`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> tag(strings) {
</span></span><span style="display:flex;"><span>  console.log(strings.raw[<span style="color:#099">0</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// strings.raw[0] 为 &#34;First line\\nSecond line&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 打印输出 &#34;First line\nSecond line&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span></code></pre></div><p>上面代码中，<code>tag</code>函数的第一个参数<code>strings</code>，有一个<code>raw</code>属性，也指向一个数组。该数组的成员与<code>strings</code>数组完全一致。比如，<code>strings</code>数组是<code>[&quot;First line\nSecond line&quot;]</code>，那么<code>strings.raw</code>数组就是<code>[&quot;First line\\nSecond line&quot;]</code>。两者唯一的区别，就是字符串里面的斜杠都被转义了。比如，strings.raw 数组会将<code>\n</code>视为<code>\\</code>和<code>n</code>两个字符，而不是换行符。这是为了方便取得转义之前的原始模板而设计的。</p>
<h2 id="模板字符串的限制">模板字符串的限制</h2>
<p>前面提到标签模板里面，可以内嵌其他语言。但是，模板字符串默认会将字符串转义，导致无法嵌入其他语言。</p>
<p>举例来说，标签模板里面可以嵌入 LaTEX 语言。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> latex(strings) {
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> <span style="color:#0086b3">document</span> <span style="color:#000;font-weight:bold">=</span> latex<span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">\newcommand{\fun}{\textbf{Fun!}}  // 正常工作
</span></span></span><span style="display:flex;"><span><span style="color:#d14">\newcommand{\unicode}{\textbf{Unicode!}} // 报错
</span></span></span><span style="display:flex;"><span><span style="color:#d14">\newcommand{\xerxes}{\textbf{King!}} // 报错
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Breve over the h goes \u{h}ere // 报错
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`</span>
</span></span></code></pre></div><p>上面代码中，变量<code>document</code>内嵌的模板字符串，对于 LaTEX 语言来说完全是合法的，但是 JavaScript 引擎会报错。原因就在于字符串的转义。</p>
<p>模板字符串会将<code>\u00FF</code>和<code>\u{42}</code>当作 Unicode 字符进行转义，所以<code>\unicode</code>解析时报错；而<code>\x56</code>会被当作十六进制字符串转义，所以<code>\xerxes</code>会报错。也就是说，<code>\u</code>和<code>\x</code>在 LaTEX 里面有特殊含义，但是 JavaScript 将它们转义了。</p>
<p>为了解决这个问题，ES2018 <a href="https://tc39.github.io/proposal-template-literal-revision/">放松</a>了对标签模板里面的字符串转义的限制。如果遇到不合法的字符串转义，就返回<code>undefined</code>，而不是报错，并且从<code>raw</code>属性上面可以得到原始字符串。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">function</span> tag(strs) {
</span></span><span style="display:flex;"><span>  strs[<span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">===</span> <span style="color:#000;font-weight:bold">undefined</span>
</span></span><span style="display:flex;"><span>  strs.raw[<span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">===</span> <span style="color:#d14">&#34;\\unicode and \\u{55}&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>tag<span style="color:#d14">`\unicode and \u{55}`</span>
</span></span></code></pre></div><p>上面代码中，模板字符串原本是应该报错的，但是由于放松了对字符串转义的限制，所以不报错了，JavaScript 引擎将第一个字符设置为<code>undefined</code>，但是<code>raw</code>属性依然可以得到原始字符串，因此<code>tag</code>函数还是可以对原字符串进行处理。</p>
<p>注意，这种对字符串转义的放松，只在标签模板解析字符串时生效，不是标签模板的场合，依然会报错。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">let</span> bad <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">`bad escape sequence: \unicode`</span>; <span style="color:#998;font-style:italic">// 报错
</span></span></span></code></pre></div>
        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>Author: </strong><a rel="author" href="http://shansec.github.io">未来可期</a></li>
        <li style="word-break:break-all"><strong>Link: </strong><a href="http://shansec.github.io/post/es6/%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%89%A9%E5%B1%95/">http://shansec.github.io/post/es6/%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%89%A9%E5%B1%95/</a></li>
        <li><strong>License: </strong>This work is under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>. Kindly fulfill the requirements of the aforementioned License when adapting or creating a derivative of this work.</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/es6/%E5%8F%98%E9%87%8F%E8%A7%A3%E6%9E%84%E8%B5%8B%E5%80%BC/">变量解构赋值</a></li>
        
        <li><a href="/post/es6/%E5%87%BD%E6%95%B0%E7%9A%84%E6%89%A9%E5%B1%95/">函数的扩展</a></li>
        
        <li><a href="/post/es6/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/">函数式编程</a></li>
        
        <li><a href="/post/es6/Symbol/">Symbol</a></li>
        
        <li><a href="/post/es6/Set%E5%92%8CMap%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">Set和Map数据结构</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/javaScript' target="_blank">javaScript</a></li>
                
                <li><a href='/tags/es6' target="_blank">es6</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "your github repo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2024 <a href="http://shansec.github.io">未来可期的博客 By 未来可期</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>


    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='http://shansec.github.io/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://shansec.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    <section class="widget">
        <h3 class="widget-title">Latest articles</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://shansec.github.io/post/ts/Typescript-class%E7%B1%BB%E5%9E%8B/" title="Typescript Class类型" target="_blank">Typescript Class类型</a>
    </li>
    
    <li>
        <a href="http://shansec.github.io/post/ts/Typescript-interface/" title="Typescript Interface" target="_blank">Typescript Interface</a>
    </li>
    
    <li>
        <a href="http://shansec.github.io/post/ts/typescript-%E5%87%BD%E6%95%B0%E7%B1%BB%E5%9E%8B/" title="Typescript 函数类型" target="_blank">Typescript 函数类型</a>
    </li>
    
    <li>
        <a href="http://shansec.github.io/post/ts/typescript-%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B/" title="Typescript 对象类型" target="_blank">Typescript 对象类型</a>
    </li>
    
    <li>
        <a href="http://shansec.github.io/post/ts/typescript-%E5%85%83%E7%BB%84%E7%B1%BB%E5%9E%8B/" title="Typescript 数组类型" target="_blank">Typescript 数组类型</a>
    </li>
    
    <li>
        <a href="http://shansec.github.io/post/ts/typescript-%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B/" title="Typescript 数组类型" target="_blank">Typescript 数组类型</a>
    </li>
    
    <li>
        <a href="http://shansec.github.io/post/ts/typescript-%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F/" title="Typescript 类型系统" target="_blank">Typescript 类型系统</a>
    </li>
    
    <li>
        <a href="http://shansec.github.io/post/ts/typescript-any%E7%B1%BB%E5%9E%8B%E5%92%8Cunknown%E7%B1%BB%E5%9E%8B%E5%92%8Cnever%E7%B1%BB%E5%9E%8B/" title="Typescript Any类型和unknown类型和never类型" target="_blank">Typescript Any类型和unknown类型和never类型</a>
    </li>
    
    <li>
        <a href="http://shansec.github.io/post/ts/typescript-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/" title="Typescript 基本用法" target="_blank">Typescript 基本用法</a>
    </li>
    
    <li>
        <a href="http://shansec.github.io/post/es6/%E8%BF%90%E7%AE%97%E7%AC%A6%E7%9A%84%E6%89%A9%E5%B1%95/" title="运算符的扩展" target="_blank">运算符的扩展</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>Categories</a></h3>
<ul class="widget-list">
    
    <li><a href="http://shansec.github.io/categories/go/">go (43)</a></li>
    
    <li><a href="http://shansec.github.io/categories/%E5%89%8D%E7%AB%AF/">前端 (61)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>Tags</a></h3>
<div class="tagcloud">
    
    <a href="http://shansec.github.io/tags/CSS/">CSS</a>
    
    <a href="http://shansec.github.io/tags/HTTP/">HTTP</a>
    
    <a href="http://shansec.github.io/tags/javaScript/">javaScript</a>
    
    <a href="http://shansec.github.io/tags/CSS/">CSS</a>
    
    <a href="http://shansec.github.io/tags/docker/">docker</a>
    
    <a href="http://shansec.github.io/tags/es6/">es6</a>
    
    <a href="http://shansec.github.io/tags/go/">go</a>
    
    <a href="http://shansec.github.io/tags/go-%E5%9F%BA%E7%A1%80/">go 基础</a>
    
    <a href="http://shansec.github.io/tags/go-%E6%A0%87%E5%87%86%E5%BA%93/">go 标准库</a>
    
    <a href="http://shansec.github.io/tags/javaScript/">javaScript</a>
    
    <a href="http://shansec.github.io/tags/jwt/">jwt</a>
    
    <a href="http://shansec.github.io/tags/package/">package</a>
    
    <a href="http://shansec.github.io/tags/pinia/">pinia</a>
    
    <a href="http://shansec.github.io/tags/redis/">redis</a>
    
    <a href="http://shansec.github.io/tags/sql/">sql</a>
    
    <a href="http://shansec.github.io/tags/sqlx/">sqlx</a>
    
    <a href="http://shansec.github.io/tags/typescript/">typescript</a>
    
    <a href="http://shansec.github.io/tags/vue/">vue</a>
    
    <a href="http://shansec.github.io/tags/%E5%AD%98%E5%82%A8/">存储</a>
    
    <a href="http://shansec.github.io/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">微信小程序</a>
    
    <a href="http://shansec.github.io/tags/%E6%A0%87%E5%87%86%E5%BA%93/">标准库</a>
    
    <a href="http://shansec.github.io/tags/%E6%A1%86%E6%9E%B6/">框架</a>
    
    <a href="http://shansec.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/">计算机原理</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">Links</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://www.liwenzhou.com/" title="李文周的博客">李文周的博客</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">Meta</h3>
        <ul class="widget-list">
            <li><a href="http://shansec.github.io/index.xml">RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>